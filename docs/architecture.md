# 架构说明（网页原型）

## 总体原则

- **服务端权威**：战斗、掉落、离线收益等都由服务端计算并落库。
- **确定性引擎**：共享战斗引擎输入完全确定（双方快照 + seed），输出可复现。
- **可审计**：关键结算保存输入快照与输出日志，便于回放与反作弊追溯。

## 代码分层（Monorepo）

- `packages/engine/`
  - 纯 TypeScript 逻辑包
  - 不依赖数据库/网络/浏览器 API
  - 作为“规则真相源”（同一份逻辑给 server/client）
- `apps/api/`
  - 账号与存档（DB）
  - 内容读取（英雄模板、关卡敌人等）
  - 战斗裁决：调用 `@am/engine`，保存 battle_log
- `apps/web/`
  - 编辑队伍、触发战斗、展示回放日志
  - 不做任何权威结算

## 关键设计点

### 1) 共享引擎 vs 服务端权威

可以同时满足：

- 前端可用引擎“本地预览”（更顺滑）
- 服务端最终裁决（防篡改）

推荐做法：

- 客户端请求 `POST /battle/simulate` 只传 `teamId + enemyId`
- 服务端从 DB/内容表取快照并计算
- 返回 `battleId + result`

### 2) RNG 与 seed

- 由服务端生成 seed 并记录到 `battle_logs`
- 所有随机行为只能来自 seed RNG
- 任何“非确定输入”（例如时间、浮点误差）都应避免进入引擎

### 3) 引擎版本与回放一致性

为避免“引擎升级导致老回放跑不出来”，建议：

- `battle_logs.engine_version` 记录引擎版本（例如 git commit）
- 若需要“重跑校验”，要么用同版本代码重跑，要么记录足够的输出摘要用于比对

### 4) 反作弊最小策略（MVP）

- 客户端不上传属性，不上传战斗过程
- 服务端验证队伍 heroIds 全部属于用户且不重复
- 战斗日志可抽样审计（例如校验回放结果摘要与存档一致）

## 部署（建议）

MVP 推荐单体部署：

- `apps/api`：Node.js 服务
- DB：SQLite（单机）或 Postgres（上线预备）
- `apps/web`：静态站点（同域或反代到 `/api`）

